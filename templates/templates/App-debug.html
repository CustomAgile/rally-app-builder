<!DOCTYPE html>
<html>
<head>
    <title>{{name}}</title>
    <!--  (c) 2022 Custom Agile.  All Rights Reserved. -->
    <!--  Build Date: {{newDate}} -->
    <!--  Version: "{{version}}"-->
    <!--  Repository: "{{{repository}}}"-->
    <script type="text/javascript" src="{{{server}}}/apps/{{{sdk}}}/sdk-debug.js"></script>
    {{#remote_javascript_files}}
    <script type="text/javascript" src="{{{.}}}"></script>
    {{/remote_javascript_files}}

    <script type="text/javascript">
        // This override allows us to manually set the security token if the 
        // user has provided an API Key in a .env file
        Ext.override('Rally.sdk.env.Global', {
            _fetchSecurityTokenBeforeRequest: function (provider, options) {
                if (!Rally.env.IoProvider.getSecurityToken() && "{{apiKey}}") {
                    Rally.env.IoProvider.setSecurityToken("{{apiKey}}");
                }
                this.callParent(arguments);    
            }
        });

        // This override resolves an issue when loading an app externally. The SDK launches the custom
        // app before Rally.environment has finished initializing, resulting in errors
        Ext.override(Rally.app.App, {
            loadSettingsAndLaunch: function () {
                if(this.getAppId()) {
                    if(this.stateful && !this.stateId) {
                        this.stateId = this.getContext().getScopedStateId('appState');
                    }
                    Deft.Chain.pipeline([
                        this._loadScope,
                        this._loadSettings,
                        this._applyDefaultSettingsAndLaunch
                    ], this);
                } else {
                    // Fix is here. Put the call to _applyDefaultSettingsAndLaunch in an onReady function
                    Rally.onReady(() => {
                        this._applyDefaultSettingsAndLaunch({});
                    });
                }
            }
        });

        // App ID is not available when running externally sometimes causing conflicts in stateIDs
        // between different apps
        // Uncomment this section of code to resolve
       /*
        Ext.override(Rally.app.Context, {
            getScopedStateId: function(stateId) {
            return Ext.create('Rally.state.ScopedStateUtil').getScopedStateId(stateId, {
                appID: '{{className}}',
                workspace: this.getWorkspaceRef(),
                filterByUser: this.getUser() ? this.getUser().getRef() : null
            });
        }
        });
       */

        Rally.loadScripts(
                [
                    {{#local_javascript_files}}
                      "{{{.}}}",
                    {{/local_javascript_files}}
                ],
        function() {
            Rally.launchApp('{{className}}', {
                name:"{{name}}",
                parentRepos:"{{{parents}}}",
                version:"{{version}}"
            });
        }, true);
    </script>

{{#remote_css_files}}
    <link rel="stylesheet" type="text/css" href="{{{.}}}"/>
{{/remote_css_files}}

{{#css_file_names}}
    <link rel="stylesheet" type="text/css" href="{{{.}}}"/>
{{/css_file_names}}
</head>
<body>
{{#html_files}}
    {{{.}}}
{{/html_files}}
</body>
</html>
